<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title> Search Engine</title>
    <link rel="icon" href="dog.ico" type="image/x-icon">
    <link rel="shortcut icon" href="dog.ico" type="image/x-icon">
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.js"></script>
    <!--<script src="change.js" type="text/javascript"></script>-->
    <link href="./grid.css" rel="stylesheet" type="text/css"/>
    <style>

        #personalPageBtn {
            text-decoration: none; /* 去掉下划线 */
            color: inherit; /* 使用其父元素的文字颜色 */
        }

        #personalPageBtn:hover {
            text-decoration: none; /* 确保鼠标悬停时也不会显示下划线 */
        }

        #homeBtn {
            text-decoration: none; /* 去掉下划线 */
            color: inherit; /* 使用其父元素的文字颜色 */
        }

        #homeBtn:hover {
            text-decoration: none; /* 确保鼠标悬停时也不会显示下划线 */
        }

        .like-btn {
            cursor: pointer;
            fill: grey; /* 默认为灰色 */
            transition: fill 0.3s;
        }

        .like-btn.liked {
            fill: red; /* 点赞后为红色 */
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }

        .pagination a {
            color: black;
            padding: 8px 16px;
            text-decoration: none;
            transition: background-color .3s;
        }

        .pagination a.active {
            background-color: #4CAF50;
            color: white;
        }

        .pagination a:hover:not(.active) {
            background-color: #ddd;
        }

        .col{
            color: black;
            height: 400px;
            overflow: hidden;
            background-color: #f0f0f0; /* 浅灰色 */
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* 边界阴影 */
            padding: 10px; /* 给内容添加一些内部间距 */
            margin-bottom: 20px; /* 为了给每个模块之间添加一些空间 */
        }

        #graph {
            border: 2px solid black;
            width: 45%;
            float: right;
            height: 30vh; /* 或您可以设置为其他值，例如300px */
            min-height: 300px; /* 设置一个合理的最小高度 */
        }

        .container {
            width: 100%;
        }


        a{
        color: blue;
        }

        input:focus{
    border-color: #66afe9;
    outline: 0;
    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6);
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6)
}
    </style>

</head>
<body>

<!--进行搜索，返回    /load?query=   转到Mycontroller-->
<h1 style="color: white;text-align: center;!">
    <span style="color:#4286F3;">M</span><span style="color:#EB4537;">a</span><span style="color:#FAC230;">n</span><span style="color:#4286F3;">g</span><span style="color:#55AF7B;">o </span>
    <span style="color:#FAC230;">S</span><span style="color:#4286F3;">e</span><span style="color:#55AF7B;">a</span><span style="color:#EB4537;">r</span><span style="color:#4286F3;">c</span><span style="color:#EB4537;">h </span>
    <span style="color:#FAC230;">E</span><span style="color:#4286F3;">n</span><span style="color:#55AF7B;">g</span><span style="color:#EB4537;">i</span><span style="color:#4286F3;">n</span><span style="color:#EB4537;">e</span>
    <!-- 登录/注册区域 -->
    <div style="float: right; text-align: right; padding: 10px;">
        <button id="home">
            <a id="homeBtn" href="/">Home</a>
        </button>
        <button id="person">
            <a id="personalPageBtn" href="person.html" style="display: none;">Personal Page</a>
        </button>
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Register</button>
    </div>

    <!-- 登录输入框 -->
    <div id="loginInput" style="display: none; position: absolute; top: 20px; right: 20px;">
        <input type="text" id="loginUserId" placeholder="Enter User ID">
        <button onclick="login()">Submit</button>
    </div>
</h1>


<form action="search" method="GET">
    <p style="color: white;text-align:center;!">

        <input style="width:430px; height:33px; box-sizing: border-box; padding: 1px 2px; border-radius:10px;" type="text" name="query" value="" />

        <input type="submit"/>
        <label>
            <input name="scope" type="radio" value="URL" onclick="toggleRadio(this)" />
            URL
        </label>
    </p>
</form>


<div class="container text-center">

    <div style="width:50%; float:left;">

        <div style="width:100%; padding:10px;">
            <form th:action="@{/search}" method="get">
                <label for="startYear">From:</label>
                <input type="number" id="startYear" name="startYear" placeholder="e.g. 2020">

                <label for="endYear">To:</label>
                <input type="number" id="endYear" name="endYear" placeholder="e.g. 2023">

                <!-- 确保还有查询关键字 -->
                <input type="hidden" name="query" th:value="${query}">

                <button type="submit">Filter</button>
            </form>
        </div>

        <div th:each="k:${resultSet}" class="col">
            <p><a th:data-web-id="${k.id}" th:href="${k.url}" th:text="${k.title}"></a></p>
            <!-- Abstract -->
            <p>
                <strong>Published Year</strong>
                <span th:text="${k.year}"></span>
                <!-- Heart icon for like action -->
                <span class="heart-icon" onclick="toggleLike(this)">
                <svg th:data-web-id="${k.id}" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path class="heart-path" d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.08C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" fill="#E0E0E0"></path>
                </svg>
            </span>
            </p>
            <!-- Keywords -->
            <p><strong>Keywords</strong> <span th:text="${k.keywords}"></span></p>
            <p th:text="${k.ab}"></p>
        </div>

    <div class="pagination">
            <th:block th:if="${totalPages > 1}">
                <a href="#" th:if="${currentPage > 1}" th:href="@{'/search?query=' + ${#uris.escapeQueryParam(query)} + '&page=' + ${currentPage - 1}}">&laquo; Prev</a>

                <!-- Display ... if the current page is greater than 5 -->
                <span th:if="${currentPage > 5}">...</span>

                <!-- Loop to display the page numbers -->
                <th:block th:each="i: ${#numbers.sequence((currentPage - 4 > 0) ? (currentPage - 4) : 1,(currentPage + 3 <= totalPages) ? (currentPage + 3) : totalPages)}">
                    <a href="#" th:href="@{'/search?query=' + ${#uris.escapeQueryParam(query)} + '&page=' + ${i}}" th:text="${i}" th:class="${i == currentPage ? 'active' : ''}"></a>
                </th:block>

                <!-- Display ... if there are more than 3 pages after the current page -->
                <span th:if="${currentPage < totalPages - 3}">...</span>

                <a href="#" th:if="${currentPage < totalPages}" th:href="@{'/search?query=' + ${#uris.escapeQueryParam(query)} + '&page=' + ${currentPage + 1}}">Next &raquo;</a>
            </th:block>
        </div>

    </div>

    <div style="border: 2px solid black; width: 45%;float:right;">
        <svg id="wordCloud" width="100%" height="30vh"></svg>
    </div>

    <div id="graph"></div>

</div>

<script>

    let lastChecked = null;

    // URL链接，再次点击，取消选择
    function toggleRadio(radio) {
        if (lastChecked === radio) {
            radio.checked = false;
            lastChecked = null;
        } else {
            lastChecked = radio;
        }
    }

    // 点赞功能
    // 当页面加载时，获取用户的点赞记录并设置图标颜色
    function updateLikeStatusOnLoad() {
        let userId = localStorage.getItem("userId");
        if (!userId){
            return;
        }
        // Fetch liked Web IDs for the user
        fetch(`/getUserLikes?userId=${userId}`)
            .then(response => response.json())
            .then(likedWebIds => {
                // Iterate over all heart icons on the page
                document.querySelectorAll('.heart-path').forEach(heartPath => {
                    let webId = heartPath.closest('.heart-icon').querySelector('svg').getAttribute('data-web-id');

                    // If the Web ID is in the list of liked Web IDs, change the color to red
                    if (likedWebIds.includes(webId)) {
                        heartPath.setAttribute('fill', '#FF0000');
                    }
                });
            })
            .catch(error => {
                console.error("Error updating like status on load:", error);
            });
    }

    // Call the function when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        let userId = localStorage.getItem("userId");
        if (userId) {
            updateLikeStatusOnLoad();
        }
    });


    function fetchUserLikes(userId) {
        fetch('/getUserLikes?userId=' + userId)
            .then(response => response.json())
            .then(likedWebIds => {
                document.querySelectorAll('.heart-path').forEach(heartPath => {
                    let webId = heartPath.parentElement.getAttribute('data-web-id');
                    if (likedWebIds.includes(webId)) {
                        heartPath.setAttribute('fill', '#FF0000');
                    } else {
                        heartPath.setAttribute('fill', '#E0E0E0');
                    }
                });
            });
    }

    function toggleLike(element) {
        let heartPath = element.querySelector('.heart-path');
        let isLiked = heartPath.getAttribute('fill') === '#FF0000'; // Check if already liked

        let webId = heartPath.parentElement.getAttribute('data-web-id');
        let userId = localStorage.getItem("userId");

        if (userId) {
            if (isLiked) {
                removeLikeFromExcel(userId, webId);
                heartPath.setAttribute('fill', '#E0E0E0');
            } else {
                saveLikeToExcel(userId, webId);
                heartPath.setAttribute('fill', '#FF0000');
            }
        }
    }

    function saveLikeToExcel(userId, webId) {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/saveLike');
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        xhr.send(JSON.stringify({ userId: userId, webId: webId }));
        xhr.onload = function() {
            if (xhr.status !== 200) {
                console.error('Failed to save like.');
            }
        };
    }

    function removeLikeFromExcel(userId, webId) {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/removeLike');
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        xhr.send(JSON.stringify({ userId: userId, webId: webId }));
        xhr.onload = function() {
            if (xhr.status !== 200) {
                console.error('Failed to remove like.');
            }
        };
    }

    // 监听用户浏览记录
    document.querySelectorAll('a[data-web-id]').forEach(link => {
        link.addEventListener('click', function(e) {
            let webId = this.getAttribute('data-web-id');
            let userId = localStorage.getItem("userId");

            // 如果用户已登录，保存点击行为
            if (userId) {
                saveClickActivity(userId, webId);
            }
        });
    });

    // 保存用户浏览记录
    function saveClickActivity(userId, webId) {
        // 获取当前的时间和日期
        let now = new Date();
        let formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;

        // 使用AJAX调用后端服务来保存数据
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/saveClickActivity');
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        xhr.send(JSON.stringify({ userId: userId, webId: webId, timestamp: formattedDate }));
        xhr.onload = function() {
            if (xhr.status !== 200) {
                console.error('Failed to save click activity.');
            }
        };
    }


    let loginBtn = document.getElementById("loginBtn");
    let registerBtn = document.getElementById("registerBtn");
    let personalPageBtn = document.getElementById("personalPageBtn");
    let Home = document.getElementById("person");

    loginBtn.addEventListener("click", function(){
        if (loginBtn.innerText === "Login") {
            var userId = prompt("Please enter your User ID:");
            if (userId) {
                loginUser(userId);
            }
        } else {
            logoutUser();
        }
    });

    registerBtn.addEventListener("click", function(){
        fetch("/existingUserIds")
            .then(response => response.json())
            .then(existingUserIds => {
                var newUserId = generateUserId(existingUserIds);
                //loginUser(newUserId);
                alert("Your Id is: "+newUserId)
                window.location.href = "survey.html";
            })
            .catch(error => {
                console.error("Error fetching existing user IDs: ", error);
            });
    });

    function loginUser(userId) {
        loginBtn.innerText = "Logout";
        registerBtn.style.display = "none";
        personalPageBtn.style.display = "inline";
        person.style.display = "inline"
        localStorage.setItem("userId", userId);
        document.cookie = "userId=" + userId + ";path=/;max-age=86400";
        window.location.reload();
    }

    function logoutUser() {
        loginBtn.innerText = "Login";
        registerBtn.style.display = "inline";
        personalPageBtn.style.display = "none";
        person.style.display = "none";
        // 清除localStorage中的userId
        localStorage.removeItem("userId");
        document.cookie = "userId=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    }

    function generateUserId(existingUserIds) {
        let newId = 0;
        while (existingUserIds.includes("User" + newId)) {
            newId++;
        }
        return newId;
    }

    // 检查是否已经登录
    window.onload = function() {
        var userId = localStorage.getItem("userId");
        if (userId) {
            loginBtn.innerText = "Logout";
            registerBtn.style.display = "none";
            personalPageBtn.style.display = "inline";
            person.style.display = "inline";
        }
        else{
            person.style.display = "none";
        }
    };


    function generateWordCloud(words) {
        var svgLocation = "#wordCloud";
        var svgElement = document.getElementById('wordCloud');
        var width = svgElement.clientWidth || 500;
        var height = svgElement.clientHeight || 500;
        var svg = d3.select(svgLocation).append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var layout = d3.layout.cloud()
            .size([width, height])
            .words(words.map(function(d) {
                return {text: d.text, size: d.size};
            }))
            .padding(5)
            .rotate(function() { return ~~(Math.random() * 2) * 90; })
            .fontSize(function(d) { return d.size; })
            .on("end", draw);

        layout.start();

        function draw(words) {
            svg.selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function(d) { return d.size + "px"; })
                .style("fill", "#000")
                .attr("text-anchor", "middle")
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
        }
    }

    var words = [
        {text: "AI", size: 50},
        {text: "Machine Learning", size: 30},
        {text: "Deep Learning", size: 20},
        {text: "Neural Network", size: 30},
        {text: "Natural Language Processing", size: 25},
        {text: "Reinforcement Learning", size: 20},
        {text: "Supervised Learning", size: 20},
        {text: "Unsupervised Learning", size: 20},
        {text: "Convolutional Neural Network", size: 15},
        {text: "Backpropagation", size: 15},
        {text: "Training Data", size: 20},
        {text: "Testing Data", size: 20},
        {text: "Generative Adversarial Network", size: 15},
        {text: "Computer Vision", size: 25},
        {text: "Feature Extraction", size: 20},
        {text: "Big Data", size: 25},
        {text: "Bias-Variance Tradeoff", size: 15},
        {text: "Data Augmentation", size: 20},
        {text: "Overfitting", size: 20},
        {text: "Transfer Learning", size: 20},
    ];

    generateWordCloud(words);

    var graph = {
        "nodes": [
            {"id": "AI", "group": 1},
            {"id": "NLP", "group": 2},
            {"id": "CV", "group": 2},
            {"id": "CNN", "group": 2},
            {"id": "RNN", "group": 2},
            {"id": "GAN", "group": 2},
        ],
        "links": [
            {"source": "AI", "target": "NLP", "value": 1},
            {"source": "AI", "target": "CV", "value": 1},
            {"source": "AI", "target": "NLP", "CNN": 1},
            {"source": "CNN", "target": "CV", "RNN": 1},
            {"source": "CNN", "target": "CV", "GAN": 1}
        ]
    };


    var svgContainer = d3.select("#graph");
    var svgWidth = +svgContainer.style("width").slice(0, -2);
    var svgHeight = +svgContainer.style("height").slice(0, -2);

    var svg = d3.select("#graph").append("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight);

    // Create the force layout
    var simulation = d3.forceSimulation()
        .nodes(graph.nodes)
        .force("link", d3.forceLink().id(d => d.id).distance(50))  // 缩短链接的距离
        .force("charge", d3.forceManyBody().strength(-500))  // 增加charge力的强度
        .force("center", d3.forceCenter(svgWidth / 2, svgHeight / 2))
        .force("collide", d3.forceCollide(20));  // 增加碰撞的半径，以避免节点重叠

    // Draw links
    var link = svg.append("g")
        .selectAll("line")
        .data(graph.links)
        .enter().append("line")
        .style("stroke-width", 2);

    // Draw nodes
    var node = svg.append("g")
        .selectAll("circle")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("r", 10)
        .style("fill", "lightblue")
        .on("click", function(d) {
            window.location.href = "http://yourwebsite.com/" + d.id;
        });

    // Draw node labels
    svg.selectAll("text")
        .data(graph.nodes)
        .enter().append("text")
        .text(d => d.id)
        .attr("dx", 12)
        .attr("dy", 4);

    // This function updates the graph's state on every tick of the simulation
    simulation.on("tick", function() {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x = boundedX(d.x, 10))
            .attr("cy", d => d.y = boundedY(d.y, 10));

        svg.selectAll("text")
            .attr("x", d => boundedX(d.x, 0))
            .attr("y", d => boundedY(d.y, 0));
    });

    // Start the simulation
    simulation.force("link")
        .links(graph.links);


    window.addEventListener("resize", function() {
        svgWidth = +svgContainer.style("width").slice(0, -2);
        svgHeight = +svgContainer.style("height").slice(0, -2);
        svg.attr("width", svgWidth).attr("height", svgHeight);
        simulation.force("center", d3.forceCenter(svgWidth / 2, svgHeight / 2)).restart();
    });

    function boundedX(position, radius) {
        return Math.max(radius, Math.min(svgWidth - radius, position));
    }

    function boundedY(position, radius) {
        return Math.max(radius, Math.min(svgHeight - radius, position));
    }

    var drag = d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);

    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
    node.call(drag);

</script>

</body>

</html>
